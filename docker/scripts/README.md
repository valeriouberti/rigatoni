# Scripts Directory

This directory contains initialization and utility scripts for local development.

## Files

### Setup Scripts

**`quick-start-local.sh`**
- **Purpose:** One-command automated setup for local development
- **Usage:** `./scripts/quick-start-local.sh`
- **What it does:**
  - Checks prerequisites (Docker, Rust, etc.)
  - Generates MongoDB keyfile (if needed)
  - Starts all Docker services (MongoDB, Redis, LocalStack, Prometheus, Grafana)
  - Waits for services to be healthy
  - Displays usage instructions and service URLs

**`mongodb-keyfile`**
- **Purpose:** Authentication keyfile for MongoDB replica set
- **Generated by:** `quick-start-local.sh` or manually with OpenSSL
- **Permissions:** Must be 400 (read-only for owner)
- **Note:** Excluded from git (see `.gitignore`)

### Initialization Scripts

**`init-mongo.sh`**
- **Purpose:** Initializes MongoDB replica set and sample data
- **When:** Automatically run by Docker Compose on first start
- **What it does:**
  - Initializes replica set `rs0`
  - Creates `testdb` database
  - Creates collections: `users`, `orders`, `products`
  - Inserts sample data

**`init-localstack.sh`**
- **Purpose:** Configures LocalStack S3 bucket
- **When:** Automatically run by LocalStack on startup
- **What it does:**
  - Creates `rigatoni-test-bucket`
  - Configures bucket settings
  - Sets lifecycle policies

### Observability Services

The docker-compose stack includes Prometheus and Grafana for metrics collection and visualization:

**Prometheus**
- **URL:** http://localhost:9090
- **Purpose:** Metrics collection and time-series database
- **Configuration:** `config/prometheus.yml`
- **Scrape targets:**
  - Rigatoni metrics at `host.docker.internal:9000/metrics`
  - Self-monitoring at `localhost:9090/metrics`
- **Scrape interval:** 5 seconds (for development)

**Grafana**
- **URL:** http://localhost:3000
- **Credentials:** admin/admin
- **Purpose:** Metrics visualization and dashboards
- **Auto-provisioned:**
  - Prometheus datasource (configured automatically)
  - Rigatoni dashboard (from `docs/grafana/rigatoni-dashboard.json`)
- **Configuration:**
  - Datasources: `config/grafana/datasources/prometheus.yml`
  - Dashboards: `config/grafana/dashboards/rigatoni.yml`

**Using Metrics:**
1. Run your Rigatoni application with metrics enabled:
   ```bash
   cargo run --example metrics_prometheus --features metrics-export
   ```
2. Your application will expose metrics at http://localhost:9000/metrics
3. Prometheus automatically scrapes metrics every 5 seconds
4. View metrics in Grafana at http://localhost:3000
5. See `docs/OBSERVABILITY.md` for detailed metrics documentation

### Utility Scripts

**`generate-test-data.sh`**
- **Purpose:** Generates test MongoDB changes
- **Usage:** `./scripts/generate-test-data.sh`
- **What it generates:**
  - New users, orders, products
  - Updates to existing documents
  - Deletions

## MongoDB Keyfile Setup

### Why is a keyfile needed?

MongoDB replica sets with authentication enabled require a keyfile for inter-node communication. Even for single-node replica sets (like our local dev setup), MongoDB enforces this requirement.

### Automatic Setup (Recommended)

The keyfile is automatically generated when you run:

```bash
./scripts/quick-start-local.sh
```

### Manual Setup

If you need to generate the keyfile manually:

```bash
# Generate keyfile
openssl rand -base64 756 > scripts/mongodb-keyfile

# Set correct permissions (IMPORTANT!)
chmod 400 scripts/mongodb-keyfile
```

**Important:** The keyfile must have permissions `400` or `600`. MongoDB will refuse to start if permissions are too open.

### Troubleshooting

**Error: "security.keyFile is required when authorization is enabled with replica sets"**

**Solution:**
```bash
# Check if keyfile exists
ls -la scripts/mongodb-keyfile

# If missing, generate it
./scripts/quick-start-local.sh
# OR
openssl rand -base64 756 > scripts/mongodb-keyfile && chmod 400 scripts/mongodb-keyfile

# Restart MongoDB
docker-compose -f docker-compose.local.yml restart mongodb
```

**Error: "permissions on mongodb-keyfile are too open"**

**Solution:**
```bash
chmod 400 scripts/mongodb-keyfile
docker-compose -f docker-compose.local.yml restart mongodb
```

**Error: "NoReplicationEnabled: This node was not started with replication enabled"**

**Solution:**
```bash
# Check MongoDB logs
docker logs rigatoni-mongodb

# Restart with fresh state
docker-compose -f docker-compose.local.yml down -v
docker-compose -f docker-compose.local.yml up -d

# Wait for initialization
sleep 30

# Check replica set status
docker exec rigatoni-mongodb mongosh --quiet \
  -u admin -p password --authenticationDatabase admin \
  --eval "rs.status()"
```

## Script Permissions

All scripts should be executable. If you get "Permission denied":

```bash
chmod +x scripts/*.sh
```

## Environment Variables

Scripts respect these environment variables:

```bash
# MongoDB
MONGODB_URI="mongodb://admin:password@localhost:27017/?replicaSet=rs0"

# Redis
REDIS_URL="redis://:redispassword@localhost:6379"

# AWS/LocalStack
AWS_ACCESS_KEY_ID="test"
AWS_SECRET_ACCESS_KEY="test"
AWS_REGION="us-east-1"
```

## Running Scripts

### Start Everything

```bash
./scripts/quick-start-local.sh
```

### Generate Test Data

```bash
./scripts/generate-test-data.sh
```

### Initialize MongoDB Manually

```bash
# Exec into container
docker exec -it rigatoni-mongodb bash

# Run init script
bash /docker-entrypoint-initdb.d/init-mongo.sh
```

### Check Replica Set

```bash
docker exec rigatoni-mongodb mongosh --quiet \
  -u admin -p password --authenticationDatabase admin \
  --eval "rs.status()"
```

## Security Note

**The `mongodb-keyfile` contains sensitive data** (even though it's only for local development). It is excluded from git via `.gitignore`. Never commit keyfiles to version control.

For production deployments:
- Use proper secret management (AWS Secrets Manager, HashiCorp Vault, etc.)
- Generate unique keyfiles for each environment
- Use TLS encryption for MongoDB connections
- Rotate keyfiles periodically
